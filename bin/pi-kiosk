#!/usr/bin/env bash
# pi-kiosk — Raspberry Pi Kiosk CLI
# https://github.com/drapesinc/pi-kiosk

set -euo pipefail

CONFIG_DIR="${HOME}/.config/pi-kiosk"
CONFIG_FILE="${CONFIG_DIR}/config"
DATA_DIR="${HOME}/.local/share/pi-kiosk"
KIOSK_SCRIPT="${HOME}/.local/bin/kiosk.sh"
LOG_FILE="/tmp/kiosk.log"
AUTOSTART_FILE="${HOME}/.config/labwc/autostart"
VERSION="1.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[pi-kiosk]${NC} $*"; }
warn()  { echo -e "${YELLOW}[pi-kiosk]${NC} $*"; }
error() { echo -e "${RED}[pi-kiosk]${NC} $*" >&2; }

# --- Config helpers ---

load_config() {
    KIOSK_URL=""
    REFRESH_INTERVAL="0"
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

save_config() {
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_FILE" <<EOF
KIOSK_URL="${KIOSK_URL}"
REFRESH_INTERVAL="${REFRESH_INTERVAL:-0}"
EOF
}

# --- Subcommands ---

cmd_install() {
    local url="${1:-}"
    if [[ -z "$url" ]]; then
        error "Usage: pi-kiosk install <URL>"
        exit 1
    fi

    info "Installing pi-kiosk v${VERSION}..."

    # Detect Raspberry Pi
    if [[ ! -f /proc/device-tree/model ]]; then
        error "This doesn't appear to be a Raspberry Pi."
        exit 1
    fi
    local model
    model=$(tr -d '\0' < /proc/device-tree/model)
    info "Detected: ${model}"

    # Check for labwc (Wayland compositor on Pi OS Bookworm+)
    if ! command -v labwc &>/dev/null; then
        error "labwc not found. This tool requires Raspberry Pi OS with labwc (Bookworm or later)."
        exit 1
    fi

    # Install dependencies
    info "Installing dependencies..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq unclutter grim chromium-browser 2>/dev/null || \
        sudo apt-get install -y -qq unclutter grim chromium 2>/dev/null || true

    # Save URL config (preserve existing refresh interval)
    load_config
    KIOSK_URL="$url"
    save_config
    info "URL set to: ${url}"

    # Install kiosk launcher script
    local lib_dir
    lib_dir="$(cd "$(dirname "$0")/../lib" 2>/dev/null && pwd)" || true
    local repo_url="https://raw.githubusercontent.com/drapesinc/pi-kiosk/main"

    mkdir -p "$(dirname "$KIOSK_SCRIPT")" "$DATA_DIR"

    if [[ -f "${lib_dir}/kiosk.sh" ]]; then
        cp "${lib_dir}/kiosk.sh" "$KIOSK_SCRIPT"
    else
        curl -sSL "${repo_url}/lib/kiosk.sh" -o "$KIOSK_SCRIPT"
    fi
    chmod +x "$KIOSK_SCRIPT"
    info "Installed kiosk launcher to ${KIOSK_SCRIPT}"

    # Configure labwc autostart
    mkdir -p "$(dirname "$AUTOSTART_FILE")"
    # Back up existing autostart if it exists and wasn't ours
    if [[ -f "$AUTOSTART_FILE" ]] && ! grep -q "pi-kiosk" "$AUTOSTART_FILE" 2>/dev/null; then
        cp "$AUTOSTART_FILE" "${AUTOSTART_FILE}.bak"
        info "Backed up existing autostart to ${AUTOSTART_FILE}.bak"
    fi

    cat > "$AUTOSTART_FILE" <<'AUTOSTART'
# pi-kiosk autostart — managed by pi-kiosk
# https://github.com/drapesinc/pi-kiosk

# Disable screen blanking
wlr-randr --output HDMI-A-1 --on 2>/dev/null || true

# Start kiosk
exec ~/.local/bin/kiosk.sh
AUTOSTART
    info "Configured labwc autostart"

    # Configure autologin
    local autologin_conf="/etc/systemd/system/getty@tty1.service.d/autologin.conf"
    if [[ ! -f "$autologin_conf" ]]; then
        info "Configuring autologin for user $(whoami)..."
        sudo mkdir -p "$(dirname "$autologin_conf")"
        sudo tee "$autologin_conf" > /dev/null <<EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $(whoami) --noclear %I \$TERM
EOF
        sudo systemctl daemon-reload
    else
        info "Autologin already configured"
    fi

    # Disable screen blanking via raspi-config if available
    if command -v raspi-config &>/dev/null; then
        sudo raspi-config nonint do_blanking 1 2>/dev/null || true
    fi

    # Disable dpms
    mkdir -p "${HOME}/.config/labwc"
    if [[ -f "${HOME}/.config/labwc/rc.xml" ]]; then
        if ! grep -q "screenSaver" "${HOME}/.config/labwc/rc.xml" 2>/dev/null; then
            # Insert before closing </labwc> tag
            sudo sed -i 's|</labwc>|  <screenSaver screenSaverTimeout="0" dpmsEnabled="false"/>\n</labwc>|' \
                "${HOME}/.config/labwc/rc.xml" 2>/dev/null || true
        fi
    fi

    info "Installation complete!"
    info ""
    info "Reboot to start the kiosk, or run: pi-kiosk restart"
    info "Manage with: pi-kiosk status | set-url | restart | logs | uninstall"
}

cmd_set_url() {
    local url="${1:-}"
    if [[ -z "$url" ]]; then
        error "Usage: pi-kiosk set-url <URL>"
        exit 1
    fi

    load_config
    KIOSK_URL="$url"
    save_config
    info "URL updated to: ${url}"

    # Restart Chromium if running
    if pgrep -x chromium-browser &>/dev/null || pgrep -x chromium &>/dev/null; then
        info "Restarting Chromium..."
        cmd_restart
    else
        info "Chromium not running. URL will take effect on next start."
    fi
}

cmd_set_refresh() {
    local input="${1:-}"
    if [[ -z "$input" ]]; then
        error "Usage: pi-kiosk set-refresh <minutes|off>"
        error "  e.g.: pi-kiosk set-refresh 60    (every hour)"
        error "        pi-kiosk set-refresh off    (disable)"
        exit 1
    fi

    load_config

    if [[ "$input" == "off" || "$input" == "0" ]]; then
        REFRESH_INTERVAL="0"
        save_config
        info "Auto-refresh disabled (direct URL mode)"
    else
        if ! [[ "$input" =~ ^[0-9]+$ ]]; then
            error "Refresh interval must be a number (minutes) or 'off'"
            exit 1
        fi
        REFRESH_INTERVAL=$(( input * 60 ))
        save_config
        info "Auto-refresh set to every ${input} minutes (${REFRESH_INTERVAL}s)"
        info "Uses smooth crossfade — no white screen flash"
    fi

    # Restart Chromium if running
    if pgrep -x chromium-browser &>/dev/null || pgrep -x chromium &>/dev/null; then
        info "Restarting Chromium to apply..."
        cmd_restart
    else
        info "Will take effect on next start."
    fi
}

cmd_status() {
    load_config
    echo "pi-kiosk v${VERSION}"
    echo "========================"

    # URL
    local url="${KIOSK_URL:-not set}"
    echo "URL:       ${url}"

    # Refresh
    local refresh="${REFRESH_INTERVAL:-0}"
    if [[ "$refresh" -gt 0 ]]; then
        echo "Refresh:   every $(( refresh / 60 )) min (smooth crossfade)"
    else
        echo "Refresh:   off"
    fi

    # Chromium process
    local chrome_pid
    chrome_pid=$(pgrep -x chromium-browser 2>/dev/null | head -1) || \
        chrome_pid=$(pgrep -x chromium 2>/dev/null | head -1) || true

    if [[ -n "$chrome_pid" ]]; then
        local uptime_str
        uptime_str=$(ps -o etime= -p "$chrome_pid" 2>/dev/null | xargs) || uptime_str="unknown"
        echo -e "Chromium:  ${GREEN}running${NC} (PID ${chrome_pid}, uptime ${uptime_str})"
    else
        echo -e "Chromium:  ${RED}not running${NC}"
    fi

    # Watchdog (kiosk.sh parent process)
    local kiosk_pid
    kiosk_pid=$(pgrep -f "kiosk.sh" 2>/dev/null | head -1) || true
    if [[ -n "$kiosk_pid" ]]; then
        echo -e "Watchdog:  ${GREEN}running${NC} (PID ${kiosk_pid})"
    else
        echo -e "Watchdog:  ${RED}not running${NC}"
    fi

    # Log file
    if [[ -f "$LOG_FILE" ]]; then
        local log_size
        log_size=$(du -h "$LOG_FILE" 2>/dev/null | cut -f1)
        echo "Log:       ${LOG_FILE} (${log_size})"
    else
        echo "Log:       no log file"
    fi

    # Config
    echo "Config:    ${CONFIG_FILE}"
}

cmd_restart() {
    info "Restarting Chromium..."

    # Kill Chromium — kiosk.sh watchdog loop will restart it
    pkill -x chromium-browser 2>/dev/null || pkill -x chromium 2>/dev/null || true

    # Give kiosk.sh a moment to restart it
    sleep 2

    if pgrep -x chromium-browser &>/dev/null || pgrep -x chromium &>/dev/null; then
        info "Chromium restarted successfully"
    else
        # If kiosk.sh isn't running, start it
        if ! pgrep -f "kiosk.sh" &>/dev/null; then
            warn "Watchdog not running. Starting kiosk.sh..."
            nohup "$KIOSK_SCRIPT" >> "$LOG_FILE" 2>&1 &
            sleep 3
            if pgrep -x chromium-browser &>/dev/null || pgrep -x chromium &>/dev/null; then
                info "Kiosk started"
            else
                error "Failed to start Chromium. Check: pi-kiosk logs"
            fi
        else
            warn "Waiting for watchdog to restart Chromium..."
        fi
    fi
}

cmd_logs() {
    if [[ ! -f "$LOG_FILE" ]]; then
        warn "No log file found at ${LOG_FILE}"
        exit 0
    fi

    if [[ "${1:-}" == "-f" || "${1:-}" == "--follow" ]]; then
        tail -f "$LOG_FILE"
    else
        tail -50 "$LOG_FILE"
    fi
}

cmd_uninstall() {
    info "Uninstalling pi-kiosk..."

    # Kill kiosk processes
    pkill -f "kiosk.sh" 2>/dev/null || true
    pkill -x chromium-browser 2>/dev/null || pkill -x chromium 2>/dev/null || true
    pkill -x unclutter 2>/dev/null || true

    # Restore autostart
    if [[ -f "${AUTOSTART_FILE}.bak" ]]; then
        mv "${AUTOSTART_FILE}.bak" "$AUTOSTART_FILE"
        info "Restored original autostart"
    else
        rm -f "$AUTOSTART_FILE"
        info "Removed autostart"
    fi

    # Remove files
    rm -f "$KIOSK_SCRIPT"
    rm -rf "$CONFIG_DIR"
    rm -rf "$DATA_DIR"
    rm -f "$LOG_FILE"

    info "Uninstalled. The pi-kiosk binary remains at $(which pi-kiosk 2>/dev/null || echo '/usr/local/bin/pi-kiosk')."
    info "Remove it with: sudo rm /usr/local/bin/pi-kiosk"
}

cmd_help() {
    cat <<EOF
pi-kiosk v${VERSION} — Raspberry Pi Kiosk Mode

Usage:
  pi-kiosk install <URL>        Set up kiosk mode with the given URL
  pi-kiosk set-url <URL>        Change the dashboard URL
  pi-kiosk set-refresh <min>    Auto-refresh every N minutes (smooth crossfade)
  pi-kiosk set-refresh off      Disable auto-refresh
  pi-kiosk status               Show kiosk status
  pi-kiosk restart              Restart Chromium (watchdog auto-recovers)
  pi-kiosk logs [-f]            Show kiosk logs (-f to follow)
  pi-kiosk uninstall            Remove kiosk mode, restore desktop
  pi-kiosk help                 Show this help

Config: ~/.config/pi-kiosk/config
Logs:   /tmp/kiosk.log
EOF
}

# --- Main ---

case "${1:-help}" in
    install)     shift; cmd_install "$@" ;;
    set-url)     shift; cmd_set_url "$@" ;;
    set-refresh) shift; cmd_set_refresh "$@" ;;
    status)      cmd_status ;;
    restart)     cmd_restart ;;
    logs)        shift; cmd_logs "$@" ;;
    uninstall)   cmd_uninstall ;;
    help|--help|-h) cmd_help ;;
    version|--version|-v) echo "pi-kiosk v${VERSION}" ;;
    *)
        error "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
