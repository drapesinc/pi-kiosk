<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>pi-kiosk</title>
<style>
  * { margin: 0; padding: 0; }
  body { background: #000; overflow: hidden; }
  iframe {
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    border: none;
    opacity: 0;
    transition: opacity 0.6s ease-in-out;
  }
</style>
</head>
<body>
<iframe id="a"></iframe>
<iframe id="b"></iframe>
<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  var url = params.get('url');
  var refreshSec = parseInt(params.get('refresh') || '3600', 10);

  if (!url) {
    document.body.style.color = '#fff';
    document.body.style.padding = '2em';
    document.body.textContent = 'pi-kiosk: no url parameter';
    return;
  }

  var frames = [document.getElementById('a'), document.getElementById('b')];
  var current = 0;
  var refreshTimer = null;

  function cacheBust(u) {
    var sep = u.indexOf('?') === -1 ? '?' : '&';
    return u + sep + '_t=' + Date.now();
  }

  function show(idx) {
    frames[idx].style.zIndex = '2';
    frames[idx].style.opacity = '1';

    var other = 1 - idx;
    // Wait for crossfade to finish, then hide the old frame
    setTimeout(function() {
      frames[other].style.zIndex = '1';
      frames[other].style.opacity = '0';
      // Clear old frame after it's invisible to free memory
      setTimeout(function() { frames[other].src = 'about:blank'; }, 300);
    }, 700);

    current = idx;
  }

  function refresh() {
    var next = 1 - current;
    var nextFrame = frames[next];

    // Position behind current frame while loading
    nextFrame.style.zIndex = '1';
    nextFrame.style.opacity = '0';

    nextFrame.onload = function() {
      nextFrame.onload = null;
      // Small delay to let the page render its first paint
      setTimeout(function() { show(next); }, 200);
    };

    nextFrame.src = cacheBust(url);
  }

  // Initial load
  frames[0].onload = function() {
    frames[0].onload = null;
    show(0);
    // Start refresh cycle after initial load
    if (refreshSec > 0) {
      refreshTimer = setInterval(refresh, refreshSec * 1000);
    }
  };
  frames[0].src = cacheBust(url);
})();
</script>
</body>
</html>
